{% extends "base.html" %}

{% block title %}Timesheet - MERQ Timesheet{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
.timesheet-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.day-cell {
    min-width: 80px;
}
.weekend {
    background-color: #d4edda !important;
}
.project-row {
    background-color: #fff3cd !important;
}
.leave-row {
    background-color: #f8d7da !important;
}
.total-row {
    background-color: #FFECACFF !important;
    color: white;
    font-weight: bold;
}
.hours-input {
    width: 70px;
    text-align: center;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 4px;
}
.hours-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="timesheet-container p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-1">Timesheet Management</h2>
            <p class="text-muted">ወርሃዊ የስራ ሰዓት መከታተያ / Monthly Timesheet Tracker</p>
        </div>
    </div>

    <!-- Month Selection -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="bi bi-calendar-range me-2"></i>Select Month & Year
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">ዓመት / Year</label>
                    <select class="form-select" id="yearSelect">
                        {% for year in years %}
                        <option value="{{ year }}" {% if year == current_eth_date.year %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ወር / Month</label>
                    <select class="form-select" id="monthSelect">
                        {% for month_num, month_name in months %}
                        <option value="{{ month_num }}" {% if month_name == current_eth_date.month_name %}selected{% endif %}>{{ month_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="loadTimesheet">
                        <i class="bi bi-arrow-clockwise me-2"></i>Load Timesheet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Projects Management -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-folder me-2"></i>Projects Management
            </h5>
            <button type="button" class="btn btn-success btn-sm" id="addProjectBtn">
                <i class="bi bi-plus-circle me-1"></i>Add Project
            </button>
        </div>
        <div class="card-body">
            <div id="projectsContainer">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Please select a month and year, then click "Load Timesheet" to see your projects.
                </div>
            </div>
        </div>
    </div>

    <!-- Timesheet Table -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="card-title mb-0">
                <i class="bi bi-table me-2"></i>Timesheet Entries
            </h5>
        </div>
        <div class="card-body">
            <div id="timesheetLoading" class="text-center py-4" style="display: none;">
                <div class="loading-spinner mb-2"></div>
                <p>Loading timesheet data...</p>
            </div>
            <div class="table-responsive" id="timesheetTableContainer" style="display: none;">
                <table class="table table-bordered" id="timesheetTable">
                    <thead id="timesheetHeader">
                        <!-- Header will be populated by JavaScript -->
                    </thead>
                    <tbody id="timesheetBody">
                        <!-- Body will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="timesheetEmpty" class="text-center py-4">
                <i class="bi bi-calendar-x display-1 text-muted"></i>
                <h4 class="text-muted">No Timesheet Loaded</h4>
                <p class="text-muted">Please select a month and year above to load the timesheet.</p>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col">
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-primary" id="prefillBtn" disabled>
                    <i class="bi bi-magic me-2"></i>Prefill Default Hours
                </button>
                <button type="button" class="btn btn-info" id="previewBtn" disabled>
                    <i class="bi bi-eye me-2"></i>Preview Summary
                </button>

                <!-- Api Test Button -->
            <!--
                <button type="button" class="btn btn-secondary" id="testApiBtn">
                    <i class="bi bi-bug me-2"></i>Test API
                </button>
            -->

                <button type="button" class="btn btn-success" id="exportBtn" disabled>
                    <i class="bi bi-download me-2"></i>Export to Excel
                </button>
                <button type="button" class="btn btn-warning" id="submitBtn" disabled>
                    <i class="bi bi-send me-2"></i>Submit to HR
                </button>
                <button type="button" class="btn btn-danger" id="clearBtn" disabled>
                    <i class="bi bi-trash me-2"></i>Clear All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <div class="mb-3">
                        <label for="allocatedHours" class="form-label">Allocated Hours</label>
                        <input type="number" class="form-control" id="allocatedHours" step="0.1" value="0.0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProjectBtn">Save Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Timesheet Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="exportFromPreview">
                    <i class="bi bi-download me-1"></i>Export to Excel
                </button>
                <button type="button" class="btn btn-warning" id="submitFromPreview">
                    <i class="bi bi-send me-1"></i>Submit to HR
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/timesheet.js') }}"></script>
<script>
// Initialize when document is ready
$(document).ready(function() {
    // Set user data from Flask template - FIXED VERSION
    window.userData = {% if user and user.user_data %}{{ user.user_data | tojson | safe }}{% else %}{}{% endif %};
    console.log('User data loaded:', window.userData);
    window.timesheetManager = new TimesheetManager();
});
</script>
{% endblock %}